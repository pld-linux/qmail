diff -urN qmail-1.03.orig/rblsmtpd-0.70/Makefile qmail-1.03/rblsmtpd-0.70/Makefile
--- qmail-1.03.orig/rblsmtpd-0.70/Makefile	Tue Aug 25 17:58:22 1998
+++ qmail-1.03/rblsmtpd-0.70/Makefile	Wed Dec 15 19:21:52 1999
@@ -129,9 +129,9 @@
 	./compile fmt_ulong.c
 
 fs.a: \
-makelib fmt_str.o fmt_ulong.o scan_uint.o scan_ulong.o
+makelib fmt_str.o fmt_ulong.o scan_uint.o scan_ulong.o scan_xlong.o
 	./makelib fs.a fmt_str.o fmt_ulong.o scan_uint.o \
-	scan_ulong.o
+	scan_ulong.o scan_xlong.o
 
 getopt.a: \
 makelib subgetopt.o sgetopt.o
@@ -236,6 +236,10 @@
 scan_ulong.o: \
 compile scan_ulong.c scan.h
 	./compile scan_ulong.c
+
+scan_xlong.o: \
+compile scan_xlong.c scan.h
+	./compile scan_xlong.c
 
 setup: \
 it install
diff -urN qmail-1.03.orig/rblsmtpd-0.70/conf-cc qmail-1.03/rblsmtpd-0.70/conf-cc
--- qmail-1.03.orig/rblsmtpd-0.70/conf-cc	Tue Aug 25 17:58:22 1998
+++ qmail-1.03/rblsmtpd-0.70/conf-cc	Wed Dec 15 20:50:02 1999
@@ -1,3 +1,3 @@
-cc -O2
+cc -O2 -DINET6
 
 This will be used to compile .c files.
diff -urN qmail-1.03.orig/rblsmtpd-0.70/ip.c qmail-1.03/rblsmtpd-0.70/ip.c
--- qmail-1.03.orig/rblsmtpd-0.70/ip.c	Tue Aug 25 17:58:22 1998
+++ qmail-1.03/rblsmtpd-0.70/ip.c	Wed Dec 15 20:21:43 1999
@@ -51,3 +51,53 @@
   if (s[len + 1] != ']') return 0;
   return len + 2;
 }
+
+#ifdef INET6
+int fmt_hexbyte(char *s, unsigned char byte)
+{
+  static char data[] = "0123456789abcdef";
+
+  if (s) {
+    *s++ = data[(byte >> 4) & 0xf];
+    *s = data[byte & 0xf];
+  }
+  return 2;
+}
+
+unsigned int ip6_fmt(s,ip6)
+char *s;
+struct ip6_address *ip6;
+{
+  unsigned int len;
+  unsigned int i, j, k;
+ 
+  len = 0;
+  for (j = 0, len = 0, k = 0; j < 8; j++) {
+    i = fmt_hexbyte(s, ip6->d[k++]); len += i; if (s) s += i;
+    i = fmt_hexbyte(s, ip6->d[k++]); len += i; if (s) s += i;
+    i = fmt_str(s,":"); len += i; if (s) s += i;
+  }
+  return len-1;
+}
+
+unsigned int ip6_scan(s,ip)
+char *s;
+struct ip6_address *ip;
+{
+  unsigned int i;
+  unsigned int j;
+  unsigned int len;
+  unsigned long u;
+ 
+  len = 0;
+  for (j = 0; j < 7; j++) {
+    i = scan_xlong(s,&u,2); if (!i) return 0; ip->d[j*2] = u; s += i; len += i;
+    i = scan_xlong(s,&u,2); if (!i) return 0; ip->d[j*2+1] = u; s += i; len += i;
+    if (*s != ':') return 0; ++s; ++len;
+  }
+  i = scan_xlong(s,&u,2); if (!i) return 0; ip->d[j*2] = u; s += i; len += i;
+  i = scan_xlong(s,&u,2); if (!i) return 0; ip->d[j*2+1] = u; s += i; len += i;
+  return len;
+}
+
+#endif
diff -urN qmail-1.03.orig/rblsmtpd-0.70/ip.h qmail-1.03/rblsmtpd-0.70/ip.h
--- qmail-1.03.orig/rblsmtpd-0.70/ip.h	Tue Aug 25 17:58:22 1998
+++ qmail-1.03/rblsmtpd-0.70/ip.h	Wed Dec 15 20:49:11 1999
@@ -1,10 +1,30 @@
 #ifndef IP_H
 #define IP_H
 
+#ifdef INET6
+struct ip6_address { unsigned char d[16]; } ;
+struct ip_address { unsigned char bogus[12]; unsigned char d[4]; } ;
+#else
 struct ip_address { unsigned char d[4]; } ;
+#endif
+
+struct ip_addr {
+  union {
+    struct ip_address ip;
+#ifdef INET6
+    struct ip6_address ip6;
+#endif
+  } addr;
+};
 
 extern unsigned int ip_fmt();
+#ifdef INET6
+extern unsigned int ip6_fmt();
+#define IPFMT 72
+extern unsigned int ip6_scan();
+#else
 #define IPFMT 19
+#endif
 extern unsigned int ip_scan();
 extern unsigned int ip_scanbracket();
 
diff -urN qmail-1.03.orig/rblsmtpd-0.70/rblsmtpd.c qmail-1.03/rblsmtpd-0.70/rblsmtpd.c
--- qmail-1.03.orig/rblsmtpd-0.70/rblsmtpd.c	Tue Dec 14 21:36:53 1999
+++ qmail-1.03/rblsmtpd-0.70/rblsmtpd.c	Wed Dec 15 20:26:43 1999
@@ -19,7 +19,7 @@
 char *rbldomain = "rbl.maps.vix.com";
 unsigned int timeout = 60;
 
-struct ip_address ip;
+struct ip_addr ix;
 stralloc rbltext = {0};
 stralloc message = {0};
 
@@ -65,9 +65,15 @@
     x = env_get("TCPREMOTEIP");
     if (!x) return;
     if (!*x) return;
-    if (x[ip_scan(x,&ip)]) return;
+    if (x[ip_scan(x,&ix.addr.ip)])
+#ifdef INET6
+      if (x[ip6_scan(x,&ix.addr.ip6)]
+	|| ((ix.addr.ip6.d[10] != 0xff)
+	&& (ix.addr.ip6.d[11] != 0xff)))
+#endif
+	return;
 
-    switch(txt(&rbltext,&ip,rbldomain)) {
+    switch(txt(&rbltext,&ix,rbldomain)) {
       case 0:
 	return;
       case -1:
diff -urN qmail-1.03.orig/rblsmtpd-0.70/scan_xlong.c qmail-1.03/rblsmtpd-0.70/scan_xlong.c
--- qmail-1.03.orig/rblsmtpd-0.70/scan_xlong.c	Thu Jan  1 01:00:00 1970
+++ qmail-1.03/rblsmtpd-0.70/scan_xlong.c	Wed Dec 15 20:23:10 1999
@@ -0,0 +1,20 @@
+#include "scan.h"
+
+unsigned int scan_xlong(s,u,l)
+register char *s;
+register unsigned long *u;
+register unsigned long l;
+{
+ register unsigned int pos; register unsigned long result;
+ register unsigned long c;
+ pos = 0; result = 0;
+ while ((((c = (unsigned long) (unsigned char) (s[pos] - '0')) < 10)
+      ||(((c = (unsigned long) (unsigned char) (s[pos] - 'a')) < 6)
+       &&(c = c + 10))
+      ||(((c = (unsigned long) (unsigned char) (s[pos] - 'A')) < 6)
+       &&(c = c + 10)))
+      &&(pos < l)
+       ) /* XXX: this gets the job done */
+  { result = result * 16 + c; ++pos; }
+ *u = result; return pos;
+}
diff -urN qmail-1.03.orig/rblsmtpd-0.70/txt.c qmail-1.03/rblsmtpd-0.70/txt.c
--- qmail-1.03.orig/rblsmtpd-0.70/txt.c	Tue Aug 25 17:58:22 1998
+++ qmail-1.03/rblsmtpd-0.70/txt.c	Wed Dec 15 20:42:27 1999
@@ -21,9 +21,9 @@
 static union { HEADER hdr; unsigned char buf[PACKETSZ]; } response;
 static char name[MAXDNAME];
 
-int txt(sa,ip,base)
+int txt(sa,ix,base)
 stralloc *sa;
-struct ip_address *ip;
+struct ip_addr *ix;
 char *base;
 {
   int n;
@@ -32,6 +32,7 @@
   int len;
   unsigned char *pos;
   unsigned char *end;
+  struct ip_address *ip = &ix->addr.ip;
 
   if (!stralloc_ready(sa,100 + str_len(base))) return -1;
   x = sa->s;
